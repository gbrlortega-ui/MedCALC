<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>S√≠ntese Familiar ‚Äì Resultado Final</title>
<style>
:root{
  --bg:#f7f7fb;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --ok:#065f46;
  --ok-bg:#d1fae5;
  --warn:#92400e;
  --warn-bg:#ffedd5;
  --bad:#7f1d1d;
  --bad-bg:#fee2e2;
  --focus:#4f46e5;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  font-size:0.9rem;
}
.container{
  max-width:1000px;
  margin:0 auto;
  padding:24px 16px 72px;
}
h1{
  margin:0 0 6px;
  font-size:1.8rem;
}
.sub{
  margin:0 0 18px;
  color:var(--muted);
  font-size:0.9rem;
}
.section-title{
  font-size:0.95rem;
  font-weight:700;
  margin:0 0 8px;
}
.card{
  background:var(--card);
  border-radius:12px;
  border:1px solid var(--border);
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 1px 3px rgba(15,23,42,.06);
}
.grid-2{
  display:grid;
  grid-template-columns:1.1fr 1.1fr;
  gap:10px;
}
@media(max-width:900px){
  .grid-2{grid-template-columns:1fr;}
}
.kpi-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  flex-wrap:wrap;
}
.label{
  font-size:.8rem;
  color:var(--muted);
}
.value-big{
  font-size:1.6rem;
  font-weight:800;
}
.pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:4px 10px;
  border-radius:999px;
  font-size:.85rem;
  font-weight:700;
  white-space:nowrap;
}
.pill-ok{background:var(--ok-bg);color:var(--ok);}
.pill-warn{background:var(--warn-bg);color:var(--warn);}
.pill-bad{background:var(--bad-bg);color:var(--bad);}
.small{
  font-size:.82rem;
  color:var(--muted);
}
ul{
  margin:4px 0 0;
  padding-left:18px;
  font-size:.86rem;
}
ul li+li{margin-top:2px}
.badge{
  display:inline-block;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:.75rem;
  color:var(--muted);
}

/* BOT√ïES FIXOS */
.controls{
  position:fixed;
  bottom:10px;
  right:14px;
  display:flex;
  gap:8px;
}
.btn{
  background:var(--focus);
  color:#fff;
  border:none;
  border-radius:999px;
  padding:6px 10px;
  cursor:pointer;
  font-size:.8rem;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:4px;
  box-shadow:0 4px 10px rgba(15,23,42,.2);
  transition:background .2s, transform .08s;
}
.btn:hover{
  background:#3730a3;
  transform:translateY(-1px);
}

/* IMPRESS√ÉO: A4 retrato, bem compactado para 1 p√°gina */
@media print{
  @page{
    size:A4 portrait;
    margin:0.6cm;
  }
  body{
    background:#fff;
    font-size:0.7rem;
  }
  .container{
    max-width:none;
    padding:6px 8px 6px;
  }
  h1{
    font-size:1.0rem;
    margin-bottom:2px;
  }
  .sub{
    display:none; /* economiza espa√ßo na impress√£o */
  }
  .card{
    box-shadow:none;
    border-color:#d1d5db;
    padding:5px 6px;
    margin-bottom:4px;
  }
  .section-title{
    font-size:0.75rem;
    margin-bottom:3px;
  }
  .grid-2{
    gap:4px;
  }
  .label{
    font-size:0.65rem;
  }
  .value-big{
    font-size:0.95rem;
  }
  .pill{
    font-size:0.6rem;
    padding:2px 5px;
  }
  .small{
    font-size:0.65rem;
  }
  ul{
    font-size:0.7rem;
    margin-top:2px;
  }
  .badge{
    font-size:0.6rem;
    padding:2px 6px;
  }
  .controls{
    display:none!important;
  }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>S√≠ntese Familiar ‚Äì APS</h1>
    <p class="sub">
      Integra√ß√£o dos instrumentos aplicados: <b>APGAR</b>, <b>Conceito Familiar (Minuchin)</b>,
      <b>Ciclo Vital</b>, <b>Determinantes em Sa√∫de</b>, <b>Coelho-Savassi</b>, <b>FIRO</b> e <b>PRACTICE</b>.
    </p>
  </header>

  <!-- 1. Bloco de √çndices Num√©ricos Principais -->
  <section class="card">
    <div class="section-title">1. √çndices globais de funcionalidade e risco</div>
    <div class="grid-2" id="gridIndices"></div>
  </section>

  <!-- 2. Conceito Familiar (Minuchin) + Ciclo Vital -->
  <section class="card">
    <div class="section-title">2. Organiza√ß√£o estrutural e ciclo de vida</div>
    <div class="grid-2">
      <div id="blocoConceito"></div>
      <div id="blocoCiclo"></div>
    </div>
  </section>

  <!-- 3. Vulnerabilidade social e risco familiar -->
  <section class="card">
    <div class="section-title">3. Vulnerabilidade social e risco familiar</div>
    <div id="blocoVulnerabilidade"></div>
  </section>

  <!-- 4. Necessidades interpessoais (FIRO) e funcionalidade PRACTICE -->
  <section class="card">
    <div class="section-title">4. Din√¢mica relacional ‚Äì FIRO & PRACTICE</div>
    <div class="grid-2">
      <div id="blocoFIRO"></div>
      <div id="blocoPractice"></div>
    </div>
  </section>

  <!-- 5. Observa√ß√µes integradas -->
  <section class="card">
    <div class="section-title">5. Observa√ß√µes integradas / notas cl√≠nicas</div>
    <div id="blocoObs" class="small"></div>
  </section>

  <div class="small">
    <span class="badge">Esta s√≠ntese organiza os achados dos instrumentos para apoiar o cuidado familiar na APS.</span>
  </div>
</div>

<!-- CONTROLES -->
<div class="controls">
  <button class="btn" id="btnVoltar">‚¨ÖÔ∏è Voltar</button>
  <button class="btn" id="btnPrint">üñ®Ô∏è Imprimir</button>
</div>

<script>
(function(){
  const byId = id => document.getElementById(id);

  function getLS(key){
    const v = localStorage.getItem(key);
    if(v === null || v === 'null' || v === 'undefined') return null;
    return v;
  }
  function getFirst(keys){
    for(const k of keys){
      const v = getLS(k);
      if(v !== null) return v;
    }
    return null;
  }

  // APGAR
  const apgarTotal = parseFloat(getLS('apgarTotal'));
  const apgarObs   = getLS('apgarObs');
  function catApgar(t){
    if(isNaN(t)) return null;
    if(t >= 7) return {txt:'Boa funcionalidade', pill:'pill-ok'};
    if(t >= 4) return {txt:'Disfun√ß√£o moderada', pill:'pill-warn'};
    return {txt:'Disfun√ß√£o grave', pill:'pill-bad'};
  }

  // Conceito Familiar (Minuchin)
  const perfilEstrutural = getLS('perfilEstrutural');
  const eixoCoesao       = getLS('eixoCoesao');
  const fronteiras       = getLS('fronteiras');
  const hierarquia       = getLS('hierarquia');
  const comunicacao      = getLS('comunicacao');
  const regras           = getLS('regras');
  const flex             = getLS('flex');
  const aliancas         = getLS('aliancas');
  const triang           = getLS('triang');
  const estressNivel     = getLS('estressoresNivel');
  const conceitoObs      = getLS('conceitoObs');

  // Ciclo Vital
  const cicloFase   = getFirst(['cicloFase']);
  const cicloTitulo = getFirst(['cicloTitulo']);
  const cicloResumo = getFirst(['cicloResumo']);

  // Determinantes em Sa√∫de
  const detTotal = parseInt(getFirst(['detTotal','determinantesTotal']));
  const detObs   = getFirst(['detObs','determinantesObs']);
  function catDeterminantes(t){
    if(isNaN(t)) return null;
    if(t <= 4) return {txt:'Baixa vulnerabilidade', pill:'pill-ok'};
    if(t <= 8) return {txt:'Vulnerabilidade moderada', pill:'pill-warn'};
    return {txt:'Alta vulnerabilidade social/familiar', pill:'pill-bad'};
  }

  // Coelho-Savassi
  const coelhoTotal   = parseInt(getFirst(['coelhoTotal']));
  const coelhoClass   = getFirst(['coelhoClassificacao']);
  const coelhoRelTxt  = getFirst(['coelhoRelacaoTexto']);
  function catCoelho(t){
    if(isNaN(t)) return null;
    if(t <= 4) return {txt:'R0 ‚Äì Sem risco', pill:'pill-ok'};
    if(t <= 6) return {txt:'R1 ‚Äì Risco leve', pill:'pill-ok'};
    if(t <= 8) return {txt:'R2 ‚Äì Risco moderado', pill:'pill-warn'};
    return {txt:'R3 ‚Äì Risco alto', pill:'pill-bad'};
  }

  // FIRO
  const firoTotal   = parseInt(getFirst(['firoTotal']));
  const firoGapSum  = parseInt(getFirst(['firoGapSum']));
  const firoObs     = getFirst(['firoObs']);
  function catFiroInt(t){
    if(isNaN(t)) return null;
    if(t <= 15) return {txt:'Intensidade muito baixa', pill:'pill-ok'};
    if(t <= 30) return {txt:'Intensidade moderada', pill:'pill-ok'};
    if(t <= 45) return {txt:'Intensidade alta', pill:'pill-warn'};
    return {txt:'Intensidade muito alta', pill:'pill-warn'};
  }
  function catFiroGap(g){
    if(isNaN(g)) return null;
    if(g <= 6) return {txt:'Boa congru√™ncia (baixa tens√£o)', pill:'pill-ok'};
    if(g <= 12) return {txt:'Congru√™ncia moderada', pill:'pill-warn'};
    return {txt:'Tens√£o alta (gaps E‚ÜîD)', pill:'pill-bad'};
  }

  // PRACTICE
  const practiceTotal = parseInt(getLS('practiceTotal'));
  const practiceCat   = getLS('practiceCat');
  const practiceDesc  = getLS('practiceDesc');
  const practiceObs   = getLS('practiceObs');

  // 1. √çNDICES GLOBAIS
  const gridIndices = byId('gridIndices');
  let htmlIndices = '';

  (function(){
    const cat = catApgar(apgarTotal);
    htmlIndices += `
      <div class="card" style="margin:0">
        <div class="kpi-row">
          <div>
            <div class="label">APGAR Familiar</div>
            <div class="value-big">${isNaN(apgarTotal)?'‚Äî':apgarTotal.toFixed(1)}</div>
            <div class="small">${apgarObs ? 'Obs.: '+apgarObs : 'Sem observa√ß√µes registradas.'}</div>
          </div>
          <span class="pill ${cat?cat.pill:'pill-warn'}">
            ${cat ? cat.txt : 'N√£o preenchido'}
          </span>
        </div>
      </div>
    `;
  })();

  (function(){
    let txt = practiceCat || 'N√£o preenchido';
    let pillClass = 'pill-warn';
    if(practiceCat){
      const lower = practiceCat.toLowerCase();
      if(lower.includes('funcional')) pillClass = 'pill-ok';
      else if(lower.includes('grave')) pillClass = 'pill-bad';
      else pillClass = 'pill-warn';
    }
    htmlIndices += `
      <div class="card" style="margin:0">
        <div class="kpi-row">
          <div>
            <div class="label">PRACTICE ‚Äì Funcionalidade familiar</div>
            <div class="value-big">${isNaN(practiceTotal)?'‚Äî':practiceTotal}</div>
            <div class="small">${practiceObs ? 'Obs.: '+practiceObs : 'Sem resumo anotado.'}</div>
          </div>
          <span class="pill ${pillClass}">${txt}</span>
        </div>
      </div>
    `;
  })();

  gridIndices.innerHTML = htmlIndices;

  // 2. CONCEITO FAMILIAR & CICLO
  const blocoConceito = byId('blocoConceito');
  blocoConceito.innerHTML = `
    <div class="label">Conceito Familiar ‚Äì Estrutural Sist√™mico (Minuchin)</div>
    <div class="kpi-row" style="margin-bottom:4px;">
      <div>
        <div class="small">Perfil estrutural</div>
        <div class="value-big" style="font-size:1.2rem">${perfilEstrutural || 'N√£o informado'}</div>
        <div class="small">
          Coes√£o: <b>${eixoCoesao || '‚Äî'}</b> ¬∑
          Fronteiras: <b>${fronteiras || '‚Äî'}</b> ¬∑
          Hierarquia: <b>${hierarquia || '‚Äî'}</b>
        </div>
        <div class="small">
          Comunica√ß√£o: <b>${comunicacao || '‚Äî'}</b> ¬∑
          Regras: <b>${regras || '‚Äî'}</b> ¬∑
          Flexibilidade: <b>${flex || '‚Äî'}</b>
        </div>
        <div class="small">
          Alian√ßas/coaliz√µes: <b>${aliancas || '‚Äî'}</b> ¬∑
          Triangula√ß√£o: <b>${triang || '‚Äî'}</b> ¬∑
          Estressores: <b>${estressNivel || '‚Äî'}</b>
        </div>
      </div>
    </div>
    <div class="small">
      ${conceitoObs ? '<b>Resumo da fam√≠lia/caso:</b> '+conceitoObs : 'Sem resumo espec√≠fico registrado neste instrumento.'}
    </div>
  `;

  const blocoCiclo = byId('blocoCiclo');
  blocoCiclo.innerHTML = `
    <div class="label">Ciclo Vital da Fam√≠lia</div>
    <div class="value-big" style="font-size:1.1rem;margin-top:2px;">
      ${cicloTitulo || 'Fase do ciclo vital n√£o informada'}
    </div>
    <div class="small" style="margin-top:4px;">
      ${cicloResumo || 'Descri√ß√£o da fase n√£o registrada no sistema.'}
    </div>
  `;

  // 3. VULNERABILIDADE SOCIAL & RISCO
  const blocoVul = byId('blocoVulnerabilidade');
  let vulHTML = '<div class="grid-2">';

  (function(){
    const cat = catDeterminantes(detTotal);
    vulHTML += `
      <div class="card" style="margin:0">
        <div class="kpi-row">
          <div>
            <div class="label">Determinantes em Sa√∫de</div>
            <div class="value-big">${isNaN(detTotal)?'‚Äî':detTotal}</div>
            <div class="small">${detObs ? 'Obs.: '+detObs : 'Sem observa√ß√µes espec√≠ficas.'}</div>
          </div>
          <span class="pill ${cat?cat.pill:'pill-warn'}">
            ${cat ? cat.txt : 'N√£o preenchido'}
          </span>
        </div>
      </div>
    `;
  })();

  (function(){
    const cat = catCoelho(coelhoTotal);
    const txtClass = coelhoClass || (cat ? cat.txt : 'N√£o preenchido');
    const pillClass = cat ? cat.pill : 'pill-warn';
    vulHTML += `
      <div class="card" style="margin:0">
        <div class="kpi-row">
          <div>
            <div class="label">Escala de Coelho-Savassi ‚Äì Risco Familiar</div>
            <div class="value-big">${isNaN(coelhoTotal)?'‚Äî':coelhoTotal}</div>
            <div class="small">
              ${coelhoRelTxt ? coelhoRelTxt : 'Rela√ß√£o morador/c√¥modo n√£o registrada em detalhe.'}
            </div>
          </div>
          <span class="pill ${pillClass}">${txtClass}</span>
        </div>
      </div>
    `;
  })();

  vulHTML += '</div>';
  blocoVul.innerHTML = vulHTML;

  // 4. FIRO & PRACTICE
  const blocoFIRO = byId('blocoFIRO');
  const catInt = catFiroInt(firoTotal);
  const catGap = catFiroGap(firoGapSum);
  blocoFIRO.innerHTML = `
    <div class="label">FIRO ‚Äì Necessidades interpessoais</div>
    <div class="kpi-row">
      <div>
        <div class="small">Intensidade interpessoal (0‚Äì54)</div>
        <div class="value-big">${isNaN(firoTotal)?'‚Äî':firoTotal}</div>
      </div>
      <span class="pill ${catInt?catInt.pill:'pill-warn'}">
        ${catInt ? catInt.txt : 'N√£o preenchido'}
      </span>
    </div>
    <div class="kpi-row" style="margin-top:4px;">
      <div>
        <div class="small">Congru√™ncia E‚ÜîD (soma dos gaps, 0‚Äì27)</div>
        <div class="value-big" style="font-size:1.2rem">${isNaN(firoGapSum)?'‚Äî':firoGapSum}</div>
      </div>
      <span class="pill ${catGap?catGap.pill:'pill-warn'}">
        ${catGap ? catGap.txt : 'N√£o informado'}
      </span>
    </div>
    <div class="small" style="margin-top:4px;">
      ${firoObs ? '<b>Resumo FIRO:</b> '+firoObs : 'Sem observa√ß√µes adicionais registradas neste instrumento.'}
    </div>
  `;

  const blocoPractice = byId('blocoPractice');
  (function(){
    let pillClass = 'pill-warn';
    if(practiceCat){
      const lower = practiceCat.toLowerCase();
      if(lower.includes('funcional')) pillClass='pill-ok';
      else if(lower.includes('grave')) pillClass='pill-bad';
      else pillClass='pill-warn';
    }
    blocoPractice.innerHTML = `
      <div class="label">PRACTICE ‚Äì Funcionalidade familiar</div>
      <div class="kpi-row">
        <div>
          <div class="small">Escore global (0‚Äì24)</div>
          <div class="value-big">${isNaN(practiceTotal)?'‚Äî':practiceTotal}</div>
          <div class="small" style="margin-top:4px;">
            ${practiceDesc || 'Descri√ß√£o de categoria n√£o registrada em detalhe.'}
          </div>
        </div>
        <span class="pill ${practiceCat?pillClass:'pill-warn'}">
          ${practiceCat || 'N√£o preenchido'}
        </span>
      </div>
      <div class="small" style="margin-top:4px;">
        ${practiceObs ? '<b>Resumo PRACTICE:</b> '+practiceObs : 'Sem resumo adicional anotado.'}
      </div>
    `;
  })();

  // 5. OBSERVA√á√ïES INTEGRADAS
  const blocoObs = byId('blocoObs');
  const obsList = [];
  if(apgarObs)    obsList.push(`<li><b>APGAR:</b> ${apgarObs}</li>`);
  if(conceitoObs) obsList.push(`<li><b>Conceito Familiar (Minuchin):</b> ${conceitoObs}</li>`);
  if(detObs)      obsList.push(`<li><b>Determinantes em Sa√∫de:</b> ${detObs}</li>`);
  if(firoObs)     obsList.push(`<li><b>FIRO:</b> ${firoObs}</li>`);
  if(practiceObs) obsList.push(`<li><b>PRACTICE:</b> ${practiceObs}</li>`);

  if(obsList.length === 0){
    blocoObs.innerHTML = 'Sem observa√ß√µes integradas adicionais registradas. Utilize este espa√ßo para sintetizar julgamento cl√≠nico, plano de cuidado e acordos com a fam√≠lia.';
  }else{
    blocoObs.innerHTML = `
      <ul>
        ${obsList.join('')}
      </ul>
      <div style="margin-top:6px;">
        Sugere-se, a partir desta s√≠ntese, elaborar plano de cuidado familiar, pactuando prioridades,
        frequ√™ncia de acompanhamento e articula√ß√£o com a rede de apoio.
      </div>
    `;
  }

  // BOT√ïES
  document.getElementById('btnVoltar').addEventListener('click', ()=>history.back());
  document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
})();
</script>
</body>
</html>
